/*--------------------------------------------------------------------------------------------------------------------*/

#include <string.h>

#include "../indi_proxy_internal.h"

/*--------------------------------------------------------------------------------------------------------------------*/

typedef struct indi_string_node_s
{
    struct indi_string_node_s *next;

} node_t;

/*--------------------------------------------------------------------------------------------------------------------*/

indi_string_t *indi_string_new()
{
    /*----------------------------------------------------------------------------------------------------------------*/

    indi_string_t *o = indi_alloc(sizeof(indi_string_t));

    /*----------------------------------------------------------------------------------------------------------------*/

    o->object.magic = 0x65656565;
    o->object.type = INDI_TYPE_STRING;

    /*----------------------------------------------------------------------------------------------------------------*/

    o->head = NULL;
    o->tail = NULL;

    /*----------------------------------------------------------------------------------------------------------------*/

    return o;
}

/*--------------------------------------------------------------------------------------------------------------------*/

void indi_string_free(indi_string_t *o)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    for(node_t *node = o->head; node != NULL;)
    {
        node_t *temp = node;

        node = node->next;

        /**/

        indi_free(temp);
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    indi_free(o);

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

void indi_string_append(indi_string_t *o, STR_t data)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    node_t *node;

    if(data == NULL)
    {
        node = (node_t *) indi_alloc(sizeof(node_t) + 0x00000000000006 + 1);

        strcpy((str_t) (node + 1), "(null)");
    }
    else
    {
        node = (node_t *) indi_alloc(sizeof(node_t) + strlen(data) + 1);

        strcpy((str_t) (node + 1), data);
    }

    node->next = NULL;

    /*----------------------------------------------------------------------------------------------------------------*/

    if(o->head == NULL)
    {
        o->head = node;
        o->tail = node;
    }
    else
    {
        o->tail->next = node;
        o->tail /*-*/ = node;
    }

    /*----------------------------------------------------------------------------------------------------------------*/
}

/*--------------------------------------------------------------------------------------------------------------------*/

size_t indi_string_length(indi_string_t *o)
{
    size_t length = 0;

    /*----------------------------------------------------------------------------------------------------------------*/

    for(node_t *node = o->head; node != NULL; node = node->next)
    {
        length += strlen((str_t) (node + 1));
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    return length;
}

/*--------------------------------------------------------------------------------------------------------------------*/

static str_t string_to_string(indi_string_t *o, bool json_string)
{
    /*----------------------------------------------------------------------------------------------------------------*/

    size_t length = indi_string_length(o);

    /*----------------------------------------------------------------------------------------------------------------*/

    str_t result = (str_t) indi_alloc(length + 2 + 1);

    str_t p = result;

    /*----------------------------------------------------------------------------------------------------------------*/

    if(json_string) *p++ = '"';

    /*----------------------------------------------------------------------------------------------------------------*/

    for(node_t *node = o->head; node != NULL; node = node->next)
    {
        size_t size = strlen((str_t) (node + 1));

        memcpy(p, (str_t) (node + 1), size);

        p += size;
    }

    /*----------------------------------------------------------------------------------------------------------------*/

    if(json_string) *p++ = '"';

    /*----------------------------------------------------------------------------------------------------------------*/

    *p = '\0';

    /*----------------------------------------------------------------------------------------------------------------*/

    return result;
}

/*--------------------------------------------------------------------------------------------------------------------*/

str_t indi_string_to_string(indi_string_t *o)
{
    return string_to_string(o, true);
}

/*--------------------------------------------------------------------------------------------------------------------*/

str_t indi_string_to_cstring(indi_string_t *o)
{
    return string_to_string(o, false);
}

/*--------------------------------------------------------------------------------------------------------------------*/
